name: band-suite (isolated)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *"

concurrency:
  group: band-suite-${{ github.ref }}
  cancel-in-progress: true

jobs:
  band_suite:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Prepare _ci_out early
        run: |
          mkdir -p _ci_out
          echo "init" > _ci_out/_keep.txt

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r dd_coherence_tool/requirements.txt
          pip install pytest

      - name: Run band suite (repo-defined)
        run: |
          set -euo pipefail
          attempt=1
          max=2
          while [ $attempt -le $max ]; do
            echo "band_suite attempt $attempt/$max"
            set +e
            python scripts/ci_band_suite.py
            rc=$?
            set -e
            if [ $rc -eq 0 ]; then
              echo "band_suite OK"
              break
            fi
            echo "band_suite failed (rc=$rc)"
            attempt=$((attempt+1))
            if [ $attempt -le $max ]; then
              echo "Retry in 10s"
              sleep 10
            else
              exit 1
            fi
          done

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: band_suite_artifacts
          path: _ci_out
